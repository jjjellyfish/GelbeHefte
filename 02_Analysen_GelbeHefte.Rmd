---
title: "Analysen Gelbe Hefte"
output: 
  pdf_document:
    latex_engine: lualatex # Per default wird pdflatex verwendet. fontspec braucht allerdings lualatex.
header-includes:
  - \usepackage[ngerman]{babel} # Sprache und Format auf Deutsch
  - \usepackage[T1]{fontenc} # Für Umlaute
  - \usepackage[utf8]{inputenc} # Alles UTF-8
  - \usepackage{fontspec} # Für Calibri
  - \setmainfont{Calibri}
  - \usepackage{lscape}
  - \usepackage[labelformat=empty]{caption}
  - \usepackage[singlelinecheck=false]{caption}
geometry: margin = 2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#tinytex::install_tinytex() #notwendig, wenn keine LateX-Distro oder für Update

library(tidyverse)
library(janitor)

library(tinytex) # Notwendig damit LaTeX-Packages richtig installiert werden
library(knitr)
library(kableExtra)
```

```{r data}
load('gh_clean.rda')
```


```{r knitr options}
# wrapper
kbl2 = function(...) {
  kableExtra::kbl(..., booktabs = T, digits=1, 
                  format.args = list(decimal.mark = ',', big.mark = ".")) %>% 
    kable_styling(latex_options = "HOLD_position", position = "left")
}

options(knitr.kable.NA = '')
```

```{r functions}
abs_freq <- function(df, x, cat_nr=NULL, rel_us=c('U2', 'U3','U4', 'U5', 'U6', 'U7', 'U7a', 'U8', 'U9')) {
  #### erstelle Outputtabelle mit absoluten Häufigkeiten
  ### benötigte Variablen extrahieren & Ausfüllstatus prüfen (liegt U vor?)
  df <- select(df, GH_ID, contains('ausgefüllt'), contains({x})) %>% 
    pivot_longer(contains({x}), names_to='u', values_to = "var") %>% 
    pivot_longer(contains('ausgefüllt'), names_to='u_data', values_to = "data") %>%
    mutate(u=str_extract(u, "[^_]+"), 
           u_data=str_extract(u_data, "[^_]+")) %>% 
    filter(u==u_data & data==1) %>% 
    filter(u %in% {rel_us}) %>%
    naniar::replace_with_na(replace = list(var = 99)) %>% 
    select(-u_data, -data) 
  

  ### optionaler Parameter cat_nr
    if(!is.null(cat_nr)) {
    # wenn cat_nr gegeben, fasse alle Antworten oberhalb dieser Kategorie zusammen
    cat_name <- paste({cat_nr},'+', sep='')
    df <- df %>% mutate(cat=case_when(as.numeric(var) >= cat_nr ~ cat_name,TRUE ~ as.character(var)))
  } 
  else {
    # wenn nicht, verwende vorhandene Ausprägungen
    df <- df %>% mutate(cat=var)
  }
  
  ### erstelle Häufigkeitstabelle
  df <- df %>%
    group_by(u, cat) %>%
    tally() %>%
    pivot_wider(., names_from = u, values_from = n) %>%
    janitor::adorn_totals(c('row', 'col'), name = c('Ges.','Ges.'), na.rm = TRUE) %>%
    untabyl() %>%
    rbind(., c('valide', colSums(.[1:(nrow(.)-2),2:length(.)], na.rm = TRUE))) %>%
    mutate_at(vars(-cat), as.numeric) %>% 
    mutate(across(.cols=2:length(.), ~replace_na(.x, 0)))
}

name_abs_tbl <- function(df, namestring, namecat='Antwort'){
  #### benenne Zeilen und Spalten für die Outputtabelle mit absoluten Häufigkeiten
  ### Zeilen
  cat_names <- c({namestring}, 'fehlend', 'gesamt n', 'valides n')
  df <- df %>% mutate(cat=cat_names)
  cat_order <- c(df$cat[1:(nrow(df)-3)], 'valides n', 'fehlend', 'gesamt n')
  df <- df %>% arrange(match(cat, cat_order))
  ### erste Spalte
  names(df) <- c({namecat}, names(df)[2:length(tmp)])
  df
}

rel_freq <- function(df) {
  #### erstelle aus der Outputtabelle mit absoluten Häufigkeiten eine 
  # Outputtabelle mit absoluten Häufigkeiten
  df <- df %>% 
  slice_head(n=-3) %>% 
  janitor::adorn_percentages('col') %>% 
  untabyl() %>% 
  janitor::adorn_totals('row', name='valides n') %>% 
  janitor::adorn_pct_formatting(digits = 1, affix_sign = FALSE) %>% 
  mutate_at(2:length(.), as.numeric)
}

# erstelle String für Tebellen-alignment (alle ab zweiter Splate rechtsbündig)
align_string <- function(df) {
  paste('l', paste(rep('r', (length(df)-1)), collapse=''), sep='')
}
```


## 2.6 Rücklauf der Erhebungen und Charakterisierung der Stichproben

### 2.6.2	Eltern

#### 2.6.2.3	Gelbe Hefte
 \newline
```{r gelbe_hefte}
tmp <- dat %>% tally() %>% tibble::rownames_to_column("Stichprobe")
tmp$Stichprobe[1] <- "Übermittelte Gelbe Hefte"
  
tmp %>% kbl2(col.names= c('Stichprobe', '[n]')) %>% 
    kable_styling(latex_options = "HOLD_position", position = "left")
```
  \linebreak
In den übermittelten Gelben Heften enthaltene U-Untersuchungen:
```{r einzelne_us, message=FALSE, warning=FALSE}
tmp1 <- dat %>% select(GH_ID, contains('Kopien')) %>% 
  pivot_longer(contains('Kopien'), names_to='u', values_to = "var") %>% 
  filter(var==1) %>% 
  mutate(u=str_extract(u, "[^_]+")) %>% 
  tabyl(u) %>% 
  mutate(percent=percent*100)

tmp2 <- dat %>% select(GH_ID, contains('ausgefüllt')) %>% 
  pivot_longer(contains('ausgefüllt'), names_to='u', values_to = "var") %>% 
  filter(var==1) %>% 
  mutate(u=str_extract(u, "[^_]+")) %>% 
  tabyl(u) %>% 
  mutate(percent=percent*100)

tmp <- bind_cols(tmp1, tmp2[2:ncol(tmp2)])

tmp %>% kbl2(col.names= c('U-Untersuchung', rep(c('[n]', '[%]'),2))) %>% 
    kable_styling(latex_options = "HOLD_position", position = "left") %>% 
  add_header_above(c("", "eingesandte \n Kopien" = 2, "Kopien mit \n Eintragungen" = 2))
```


## 4.3	Häufigkeit der Dokumentation 

### 4.3.1	Dokumentation von Auffälligkeiten 

#### 4.3.1.1	Auffälligkeiten bei der Untersuchung

 \newline

Anzahl Kreuze im Abschnitt „Untersuchung“
```{r Untersuchung, echo=FALSE, warning=FALSE, message=FALSE}
tmp <- abs_freq(df=dat, x='Untersuchung', cat_nr=3)

cat_names <- c('0 Kreuze', '1 Kreuz', '2 Kreuze', '3+ Kreuze')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names)

## absolute Tabelle
rowline_at <- nrow(tmp)-3

tmp %>% kbl2(col.names= c('Antwort', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Antwort', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% 
  kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

#### 4.3.1.2 Ausgewählte Auffälligkeiten im Abschnitt Untersuchung
 \newline

U2, U3: Inspektion: morphologische Auffälligkeiten (z. B. Ptosis, Leuko-korie, Bulbusgrößenauffälligkeiten, Kolobom)
```{r morphologische_Auffaelligkeiten}
tmp <- abs_freq(df=dat, x='morphologische_Auffaelligkeiten', rel_us = c('U2', 'U3'))

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U2, U3: Prüfung im durchfallenden Licht: Transilluminationsauffälligkeit bei Trübung der brechenden Medien
```{r Transillumination}
tmp <- abs_freq(df=dat, x='Transillumination', rel_us = c('U2', 'U3'))

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U4-U7: Brückner-Test: Transilluminationsunterschied (z.B. bei Trübung der brechenden Medien, Strabismus, Anisometropie)
```{r Brueckner}
tmp <- abs_freq(df=dat, x='Brueckner')

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U6: Auffälligkeiten an Zähnen und Schleimhaut
```{r Zaehne}
tmp <- abs_freq(df=dat, x='Zaehne') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak
U6: Häufigkeit des Verweises zum Zahnarzt 
```{r Verweis_Zahnarzt}
tmp <- abs_freq(df=dat, x='U6_Verweis_Zahnarzt') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```


  \linebreak
U7a-U9: Inspektion: morphologische Auffälligkeit
```{r morphologische_Auffaelligkeiten2}
tmp <- abs_freq(df=dat, x='morphologische_Auffaelligkeiten', rel_us=c('U7a', 'U8', 'U9')) 

### Ja-Ausprägung hinzufügen
ja <- tmp[1,]
ja[1,names(ja)] = data.frame('ja', 0, 0, 0, 0)
tmp <- bind_rows(ja, tmp)

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Inspektion: Nystagmus
```{r Nystagmus}
tmp <- abs_freq(df=dat, x='Nystagmus') 

### Sortierung ändern
tmp <- tmp %>% arrange(match(cat, '1', '2')) %>% 
  mutate(across(.cols=2:length(.), ~replace_na(.x, 0)))

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Inspektion: Kopffehlhaltung
```{r Kopffehlhaltung}
tmp <- abs_freq(df=dat, x='Kopffehlhaltung') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Pupillenstatus: auffällig (Vergleich Größe, Form, Lichtreaktion rechts/links)
```{r Pupillenstatus}
tmp <- abs_freq(df=dat, x='Pupillenstatus') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Hornhautreflexbildchen: auffällig (Strabismus)
```{r Hornhaut}
tmp <- abs_freq(df=dat, x='Hornhaut') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Stereo-Test (z. B. Lang-Test, Titmus-Test, TNO-Test): auffällig
```{r Stereo}
tmp <- abs_freq(df=dat, x='Stereo') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Sehtest (monokulare Prüfung...): Sehschwäche rechts
```{r Sehschwaeche_rechts}
tmp <- abs_freq(df=dat, x='Sehschwaeche_rechts') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Sehtest (monokulare Prüfung...): Sehschwäche links
```{r Sehschwaeche_links}
tmp <- abs_freq(df=dat, x='Sehschwaeche_links') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

U7a-U9: Sehtest (monokulare Prüfung...): Rechts-Links-Differenz
```{r Sehschwaeche_Differenz}
tmp <- abs_freq(df=dat, x='Sehschwaeche_Differenz') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```



#### 4.3.1.3	Auffälligkeiten im Abschnitt Ergebnisse
 \newline
Gesamtergebnis: Auffälligkeiten zur Beobachtung – Eintrag liegt vor
```{r Anamnese}
# Variable umbenennen
names(dat) <- str_replace(names(dat), "Anamnese_Freitext", "Ana_Freitext")

tmp <- abs_freq(df=dat, x='Anamnese') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Eintrag liegt vor', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Eintrag liegt vor', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

#### 4.3.1.4	Relevante anamnestische Ergebnisse
 \newline

```{r Anamnese_Freitext_n}
# Freitexte rausziehen
tmp <- dat %>% select(GH_ID, contains('ausgefüllt'), contains('Ana_Freitext')) %>%
  pivot_longer(contains('Ana_Freitext'), names_to='u', values_to = "var") %>%
  pivot_longer(contains('ausgefüllt'), names_to='u_data', values_to = "data") %>%
  mutate(u=str_extract(u, "[^_]+"),
         u_data=str_extract(u_data, "[^_]+")) %>%
  filter(u==u_data & data==1) %>%
  naniar::replace_with_na(replace = list(var = 99)) %>%
  select(-u_data, -data)

### Vorhandensein ausgeben
tmp2 <- tmp %>%
  mutate(eintrag=case_when(
    is.na(var) ~ 'Nein', 
    TRUE ~ 'Ja')) %>% 
  group_by(u, eintrag) %>%
  tally() %>%
  pivot_wider(., names_from = u, values_from = n) %>%
  janitor::adorn_totals(c('row', 'col'), name = c('Ges.','Ges.'), na.rm = TRUE) %>%
  untabyl()

## absolute Tabelle
rowline_at <- nrow(tmp2)-1
tmp2 %>% kbl2(col.names= c('Eintrag vorhanden', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- tmp2 %>% 
  slice_head(n=-1) %>% 
  janitor::adorn_percentages('col') %>% 
  untabyl() %>% 
  janitor::adorn_totals('row', name='Ges.') %>% 
  janitor::adorn_pct_formatting(digits = 1, affix_sign = FALSE) %>% 
  mutate_at(2:length(.), as.numeric)

tmp2 %>% kbl2(col.names= c('Eintrag vorhanden', paste(names(.)[2:length(.)], '[%]', sep=' ')), 
              align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

Freitext zu relevanten anamnestischen Ergebnissen
```{r Anamnese_Freitext_text}
tmp <- tmp %>% 
  #naniar::replace_with_na(replace = list(var = 99)) %>% #[unlesbar]???
  na.omit() %>% 
  arrange(u, var)

tmp %>% 
  select(u, var) %>% 
  kbl2(col.names= c('U-Untersuchung', 'Relevante anamnestische Ergebnisse'), longtable=TRUE) %>% 
  kable_styling(latex_options = c("hold_position", "repeat_header"), full_width = TRUE) #%>% 
  #kableExtra::column_spec(2, width = "50em") # funktioniert im Chunk, wird aber nicht geknittet
  
```



### 4.3.2	Dokumentation von erweitertem Beratungsbedarf 

#### 4.3.2.1 Erweiterter Beratungsbedarf insgesamt
 \newline
gesamter Abschnitt "Beratung" – Anzahl Kreuze gesetzt
```{r Beratung}
tmp <- abs_freq(df=dat, x='Beratung', cat_nr=5) 

cat_names <- c('0 Kreuze', '1 Kreuz', '2 Kreuze', '3 Kreuze', '4 Kreuze', '5+ Kreuze')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names)

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Antwort', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Antwort', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

#### 4.3.2.2	Sprachberatung
 \newline
Häufigkeit der Nicht-Erfüllung der vorgegebenen Items zur Sprache im Rahmen der orientierenden Beurteilung der Entwicklung (Item ist anzukreuzen, wenn nicht erfüllt)
```{r OBE_Sprachdefizit}
tmp <- abs_freq(df=dat, x='OBE_Sprache') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

Häufigkeit von erweitertem Beratungsbedarf zum Thema Sprache
```{r Beratung_Sprache}
tmp <- abs_freq(df=dat, x='Beratung_Sprache') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Kreuz gesetzt')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Kreuz gesetzt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Kreuz gesetzt', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```


## 4.4	Lückenlosigkeit der Dokumentation

### 4.4.1 Lückenlose Dokumentation einer U-Untersuchung

Ausgewertet werden nur U-Untersuchungen, zu denen Kopien vorliegen, in denen mindestens eine Eintragung getätigt wurde (d.h. die U-Untersuchung wurde in irgendeinem Maße ausgefüllt) und für die die Ergebnisseite vorliegt
```{r u2, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('KGewicht', 'KLaenge', 'Kopfumfang', 'keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'VitaminK_ja', 
          'VitaminK_Dosis_2mg', 'VitaminK_abwDosis', 'VitaminK_nein')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U2_ausgefüllt==1) %>% 
  select(GH_ID, contains('U2')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U2_].+")

## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    vitk_easy = case_when(
      VitaminK_ja == 1 | VitaminK_nein == 1 ~ 1,
      TRUE ~ 0
    ),
    vitk_hard = case_when(
      (VitaminK_ja == 1 & (VitaminK_Dosis_2mg == 1 | VitaminK_abwDosis == 1)) | VitaminK_nein == 1 ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & vitk_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & vitk_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )


# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u2 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U2')

tmp2 <- tmp %>% 
  select(kgewicht:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Körpergewicht dokumentiert', 
                    'Körperlänge dokumentiert', 
                    'Kopfumfang dokumentiert', 
                    'Auffälligkeiten dokumentiert', 
                    'Vitamin K dokumentiert (vereinfacht)',
                    'Vitamin K dokumentiert (vollständig)', 
                    'U-Untersuchung lückenlos (vereinfacht)', 
                    'U-Untersuchung lückenlos (vollständig)')

names(tmp2) <- c('U2', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
lueckl <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
  

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE) 
```
  \linebreak

```{r u3, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('KGewicht', 'KLaenge', 'Kopfumfang', 'keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'VitaminK_ja', 
          'VitaminK_Dosis_2mg', 'VitaminK_abwDosis', 'VitaminK_nein', 'OBE_altersgem')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U3_ausgefüllt==1) %>% 
  select(GH_ID, contains('U3')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U3_].+")

## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0), 
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    vitk_easy = case_when(
      VitaminK_ja == 1 | VitaminK_nein == 1 ~ 1,
      TRUE ~ 0
    ),
    vitk_hard = case_when(
      (VitaminK_ja == 1 & (VitaminK_Dosis_2mg == 1 | VitaminK_abwDosis == 1)) | VitaminK_nein == 1 ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe == 1 &kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & vitk_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe == 1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & vitk_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )


# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u3 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U3')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert', 
                    'Körperlänge dokumentiert',
                    'Kopfumfang dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Vitamin K dokumentiert (vereinfacht)',
                    'Vitamin K dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')

names(tmp2) <- c('U3', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')

lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 


rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u4, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'Kopfumfang', 'keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U4_ausgefüllt==1) %>% 
  select(GH_ID, contains('U4')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U4_].+")

## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe == 1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u4 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U4')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert',
                    'Körperlänge dokumentiert',
                    'Kopfumfang dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)', 
                    'U-Untersuchung lückenlos (vollständig)')


names(tmp2) <- c('U4', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')

lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 


rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u5, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'Kopfumfang', 'keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U5_ausgefüllt==1) %>% 
  select(GH_ID, contains('U5')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U5_].+")

## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u5 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U5')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert', 
                    'Körperlänge dokumentiert',
                    'Kopfumfang dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')

names(tmp2) <- c('U5', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u6, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'Kopfumfang', 'keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U6_ausgefüllt==1) %>% 
  select(GH_ID, contains('U6')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U6_].+")


## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u6 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U6')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert',
                    'Körperlänge dokumentiert',
                    'Kopfumfang dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')

names(tmp2) <- c('U6', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u7, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'Kopfumfang', 'BMI','keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U7_ausgefüllt==1) %>% 
  select(GH_ID, contains('U7'), -contains('U7a')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U7_].+")


## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    kumpfang = ifelse(Kopfumfang == 1, 1, 0), 
    bmi = ifelse(BMI == 1, 1, 0),
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & bmi == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & kumpfang == 1 & bmi == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u7 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U7')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert', 
                    'Körperlänge dokumentiert',
                    'Kopfumfang dokumentiert',
                    'BMI dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')

names(tmp2) <- c('U7', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u7a, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'BMI','keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U7a_ausgefüllt==1) %>% 
  select(GH_ID, contains('U7a')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U7a_].+")


## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    bmi = ifelse(BMI == 1, 1, 0),
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u7a <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U7a')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert',
                    'Körperlänge dokumentiert',
                    'BMI dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')


names(tmp2) <- c('U7a', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u8, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'BMI','keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U8_ausgefüllt==1) %>% 
  select(GH_ID, contains('U8')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U8_].+")


## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    bmi = ifelse(BMI == 1, 1, 0),
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u8 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U8')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert',
                    'Körperlänge dokumentiert',
                    'BMI dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')


names(tmp2) <- c('U8', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

```{r u9, message=FALSE, warning=FALSE}
## relevante Variablen filtern & Datensatz vorbereiten
vars <- c('OBE_altersgem','KGewicht', 'KLaenge', 'BMI','keineAuffaelligkeiten', 
          'Auffaelligkeiten', 'Impfstatus_ja','Impfstatus_nein', 'Impfstatus_fehlend')

tmp <- dat %>% 
  select(GH_ID, contains('ausgefüllt'), matches(vars), 
         -contains('morphologische'), -contains('Freitext')) %>% 
  filter(U9_ausgefüllt==1) %>% 
  select(GH_ID, contains('U9')) 

# Angaben rauslöschen, wenn die Seite fehlt
del <- tmp %>% filter_at(vars(2:ncol(.)), any_vars(grepl("99", .)))
tmp <- anti_join(tmp, del)

# Variablen umbenennen
names(tmp)[2:length(tmp)] <- str_extract(names(tmp)[2:length(tmp)], "[^U9_].+")


## Kriterien umsetzen
tmp <- tmp %>% 
  mutate(
    obe = ifelse(OBE_altersgem == 1, 1, 0),
    kgewicht = ifelse(KGewicht == 1, 1, 0),
    klaenge =  ifelse(KLaenge == 1, 1, 0),
    bmi = ifelse(BMI == 1, 1, 0),
    auff = case_when(
      keineAuffaelligkeiten == 1 | Auffaelligkeiten == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_easy = case_when(
      Impfstatus_ja == 1  ~ 1,
      Impfstatus_nein == 1 | Impfstatus_fehlend == 1 ~ 1,
      TRUE ~ 0
    ),
    impf_hard = case_when(
      Impfstatus_ja == 1 | (Impfstatus_nein == 1 & Impfstatus_fehlend == 1) ~ 1,
      TRUE ~ 0
    ),
    ges_easy = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_easy == 1 ~ 1, 
      TRUE ~ 0
    ),
    ges_hard = case_when(
      obe==1 & kgewicht == 1 & klaenge == 1 & bmi == 1 & auff == 1 & impf_hard == 1 ~ 1, 
      TRUE ~ 0
    )
  )

# Ausfüllstand pro ID für Lückenlosigkeit aller Us über das Kind ablegen
fill_u9 <- tmp %>% select(GH_ID, ges_easy, ges_hard) %>% mutate(u='U9')

tmp2 <- tmp %>% 
  select(obe:ges_hard) %>% 
  mutate_all(., ~ as.factor(.)) %>% 
  dlookr::diagnose_category(.) %>% 
  select(variables, levels, freq, ratio) %>% 
  pivot_wider(names_from = levels, values_from=c('freq', 'ratio')) %>% 
  select(variables, contains('1'), contains('0'))

tmp2$variables <- c('Ergebnis OBE dokumentiert',
                    'Körpergewicht dokumentiert', 
                    'Körperlänge dokumentiert',
                    'BMI dokumentiert',
                    'Auffälligkeiten dokumentiert',
                    'Impfstatus dokumentiert (vereinfacht)',
                    'Impfstatus dokumentiert (vollständig)',
                    'U-Untersuchung lückenlos (vereinfacht)',
                    'U-Untersuchung lückenlos (vollständig)')


names(tmp2) <- c('U9', 'Ja [n]', 'Ja [%]', 'Nein [n]', 'Nein [%]')

# Lückenlosigkeit gesamt ablegen
tmp <- tmp2 %>% slice_tail(n=2) %>% 
  pivot_longer(cols=c('Ja [n]', 'Nein [n]', 'Ja [%]', 'Nein [%]'), 
               names_to = c('ausgefüllt','value'), 
               names_sep = ' ', values_to = c('n')) %>% 
  pivot_wider(names_from = 'value', values_from = 'n')
lueckl <- bind_cols(lueckl, tmp[3:length(tmp)]) 

rowline_at <- nrow(tmp2) - 2
tmp2 %>% kbl2() %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

```{r Lueckenlosigkeite_U_gesamt}
names(lueckl)[1:length(lueckl)] <- c('Feld', 'ausgefüllt', 'U2', 'U2 [%]', 'U3', 'U3 [%]', 
                                     'U4', 'U4 [%]', 'U5', 'U5 [%]', 'U6', 'U6 [%]', 
                                     'U7', 'U7 [%]', 'U7a', 'U7a [%]', 'U8', 'U8 [%]',
                                     'U9', 'U9 [%]')

lueckl <- lueckl %>% 
  mutate(Ges.=rowSums(select(., U2, U3, U4, U5, U6, U7, U7a, U8, U9), na.rm = TRUE))

```

  \linebreak

Untersuchung lückenlos (vereinfachte Definition)
```{r vereinfacht }
lueckl %>% 
  slice_head(n=2) %>% 
  select(- Feld, -contains('%')) %>% 
  janitor::adorn_totals('row', name='valides n') %>% 
  kbl2(col.names= c('ausgefüllt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(2, extra_css = "border-bottom: 1px solid", hline_after=TRUE)

lueckl %>% 
  slice_head(n=2) %>%
  mutate(`Ges. [%]`= (Ges. / sum(Ges.))*100) %>% 
  select(ausgefüllt, contains('%')) %>% 
  janitor::adorn_totals('row', name='valides n') %>% 
  kbl2() %>% 
  row_spec(2, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```

  \linebreak

Untersuchung lückenlos (vollständige Definition)
```{r vollständig }
lueckl %>% 
  slice_tail(n=2) %>% 
  select(- Feld, -contains('%')) %>% 
  janitor::adorn_totals('row', name='valides n') %>% 
  kbl2(col.names= c('ausgefüllt', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(2, extra_css = "border-bottom: 1px solid", hline_after=TRUE)

lueckl %>% 
  slice_tail(n=2) %>%
  mutate(`Ges. [%]`= (Ges. / sum(Ges.))*100) %>% 
  select(ausgefüllt, contains('%')) %>% 
  janitor::adorn_totals('row', name='valides n') %>% 
  kbl2() %>% 
  row_spec(2, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```
  \linebreak

Überblick über vorliegende U-Untersuchungen (Flowchart): 
```{r Ausfuellstand_Flowchart}
#liegen Kopien & Eintragungen vor?
tmp <- dat %>% 
  select(GH_ID, contains('Kopien'), contains('ausgefüllt')) %>% 
  pivot_longer(contains('Kopien'), names_to='u_kopien', values_to = "kopien") %>%
  pivot_longer(contains('ausgefüllt'), names_to='u_data', values_to = "data") %>%
  mutate(u_kopien=str_extract(u_kopien, "[^_]+"), 
         u_data=str_extract(u_data, "[^_]+")) %>% 
  filter(u_kopien == u_data) %>%
  select(GH_ID, u = u_kopien, kopien, data)

# Ausfüllstand anhängen
fill <- bind_rows(fill_u2, fill_u3, fill_u4, fill_u5, fill_u6, fill_u7, fill_u7a, fill_u8, fill_u9)
tmp <- left_join(tmp, fill, by=c('GH_ID', 'u')) %>% 
  mutate(
    #liegen Kopien vor? (NA nullsetzen)
    kopien=ifelse(kopien==1, 1, 0),
    #liegen Daten vor? (NA nullsetzen)
    data=ifelse(data==1, 1, 0),
    #liegt die Ergebnisseite vor? (Daten da, aber Ausfüllstand fehlt)
    results=ifelse(data==0 | (data==1 & is.na(ges_easy)), 0, 1))

# für später ablegen
lueckl_heft <- tmp

# zusammenfassen, transponieren & aufräumen
tmp <- tmp %>% group_by(u) %>% 
  summarize(kopien_data=sum(kopien), 
            sum_data=sum(data),
            sum_result=sum(results),
            sum_ges_easy=sum(ges_easy, na.rm=TRUE), 
            sum_ges_hard=sum(ges_hard, na.rm=TRUE))

tmp <- as.data.frame(t(tmp)) 
 rownames(tmp) <- c('', 'Kopien liegen vor', 'irgendwelche Eintragungen liegen vor', 'Ergebnisseite liegt vor', 
                   'U lückenlos ausgefüllt (vereinfacht)', 'U lückenlos ausgefüllt (vollständig)')

# Tabellenoutput putzen 
tmp <- tmp %>% 
  janitor::row_to_names(row_number = 1) %>% 
  tibble::rownames_to_column('Fallzahlen') %>% 
  mutate_at(2:length(.), as.numeric) %>%
  janitor::adorn_totals('col', name='Ges.') #%>%
  
tmp %>% kbl2(col.names= c('Fallzahlen', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  kable_styling(latex_options="scale_down") %>% 
  kable_styling(latex_options = "HOLD_position")
```



### 4.4.2 Lückenlose Dokumentation eines Gelben Hefts

Für Kinder, die zum Zeitpunkt der Datenerhebung die U-Untersuchungen U8 und U9 durchlaufen haben (= die letzte dokumentierte U-Untersuchung ist eine U8 bzw. U9) kann nicht sichergestellt werden, dass sie bei der Geburt ein gemäß der 2016 in Kraft getretenen Neufassung der Kinder-Richtlinie überarbeitetes Gelbes Heft erhalten haben. Die Lückenlosigkeit der Gelben Hefte wird daher anhand von Kindern überprüft, deren letzte U-Untersuchung die U7a gewesen ist. 


```{r Lueckenlosigkeit_Heft, echo=FALSE, warning=FALSE, message=FALSE}
### data prep
# Datensatz mit Ausfüll-Flow aufgreifen und U nummerieren
tmp <- lueckl_heft %>% 
  group_by(GH_ID) %>%
  mutate(u_nr = seq_along(u)) 

# U2 als erste U-Untersuchung festlegen
tmp2 <- tmp %>% 
  slice_min(order_by = u_nr, n=1) %>% 
  mutate(u_min =u_nr) 
tmp <- left_join(tmp, tmp2)

# letzte U mit Kopien bestimmen
tmp2 <- tmp %>%
  filter(kopien == 1) %>%
  slice_max(order_by = u_nr, n=1) %>%
  mutate(u_max = u_nr) #%>%
tmp <- left_join(tmp, tmp2)

# auffüllen & alle Us davor und danach entfernen --> Grundgesamtheit
tmp <- tmp %>%
  group_by(GH_ID) %>%
  tidyr::fill(u_min, .direction='down') %>% #default 
  tidyr::fill(u_max, .direction='up') %>%
  filter(u_max == 7) %>% 
  ungroup()


#***************************
### Lückenlosigkeit operationalisieren
# fehlende Kopien identifizieren
tmp <- tmp %>% 
  group_by(GH_ID) %>% 
  mutate(lueckl_copy=ifelse(any(kopien==0),0,1))

# fehlende Angaben identifizieren
mis_data <- tmp %>% 
  group_by(GH_ID) %>%
  filter(!any(kopien == 0)) %>%
  mutate(lueckl_data=ifelse(any(data==0),0,1))
tmp <- left_join(tmp, mis_data) 

# fehlende Ergebnisseiten identifizieren
mis_res <- tmp %>% 
  group_by(GH_ID) %>%
  filter(!any(data == 0)) %>%
  mutate(lueckl_res=ifelse(any(results==0),0,1))
tmp <- left_join(tmp, mis_res)

# fehlende lückenlos ausgefüllte Us identifizieren (vereinfacht)
mis_easy <- tmp %>% 
  group_by(GH_ID) %>%
  filter(!any(results == 0)) %>%
  mutate(lueckl_easy=ifelse(any(ges_easy==0),0,1))
tmp <- left_join(tmp, mis_easy)

# fehlende lückenlos ausgefüllte Us identifizieren (vollständig)
mis_hard <- tmp %>% 
  group_by(GH_ID) %>%
  filter(!any(results == 0)) %>%
  mutate(lueckl_hard=ifelse(any(ges_hard==0),0,1)) %>%
  ungroup()

tmp <- left_join(tmp, mis_hard)

check <- dlookr::diagnose(tmp)
lueckl_heft_u2u7a <- tmp
```


```{r Lueckenlosigkeit_Heft_output}
tmp <- lueckl_heft_u2u7a %>% 
  filter(u_nr == u_min) %>% #eine Reihe pro Heft übrig behalten
  select(GH_ID, contains('lueckl')) %>%
  mutate(n=n()) %>% 
  ungroup()

tmp2 <- tmp %>% 
  summarize(n_hefte=sum(n, na.rm=TRUE),
            lueckl_copy=sum(lueckl_copy, na.rm=TRUE), 
            lueckl_data=sum(lueckl_data, na.rm=TRUE),
            lueckl_res=sum(lueckl_res, na.rm=TRUE),
            lueckl_easy=sum(lueckl_easy, na.rm=TRUE), 
            lueckl_hard=sum(lueckl_hard, na.rm=TRUE))


# Transponieren & relative Häufigkeiten (wechselnde Nenner)
tmp2 <- as.data.frame(t(tmp2)) 
tmp2 <- tmp2 %>% 
  tibble::rownames_to_column('Text') %>% 
  mutate(freq_ges = V1 / V1[1]*100,
         freq_copy = V1 / V1[2]*100,
         freq_data = V1 / V1[3]*100,
         freq_res = V1 / V1[4]*100) %>%
  mutate_at(vars(freq_ges:freq_res), ~ replace(., .>100, NA))


# Tabellenoutput putzen 
tmp2$Text <- c('Übermittelte Gelbe Hefte','Kopien liegen für alle Us lückenlos vor', 
               'irgendwelche Eintragungen liegen für alle Us lückenlos vor', 
               'Ergebnisseite liegt für alle Us lückenlos vor', 'alle Us lückenlos ausgefüllt (vereinfacht)', 
               'alle Us lückenlos ausgefüllt (vollständig)')

# Spaltennamen zu lang
tmp2 %>% 
  kbl2(col.names= c('Grad der Lückenlosigkeit', 'n', "%[1]", '%[2]', '%[3]', '%[4]')) %>% 
  add_footnote(c("Anteil an allen erhaltenen Gelben Heften", 
                 'Anteil an allen Gelben Heften mit lückenlosen Kopien', 
                 'Anteil an allen Gelben Heften mit lückenlosen Kopien mit Eintragungen',
                 'Anteil an allen Gelben Heften mit lückenlos vorhandenen Ergebnisseiten'), notation="number")
```

  \linebreak
In wie vielen Heften fehlen wie viele U-Untersuchungen? (Unterteilt danach, an welcher Stelle Sie fehlen)
```{r Lueckenlosigkeit_Heft_Anzhal_fehlendeUs, warning=FALSE, message=FALSE}
tmp <- lueckl_heft_u2u7a %>%
  group_by(GH_ID) %>%
  mutate(mis_copy=7-sum(kopien),
         mis_data=7-sum(data),
         mis_results=7-sum(results),
         mis_easy=7-sum(ges_easy, na.rm=TRUE),
         mis_hard=7-sum(ges_hard, na.rm=TRUE)) %>%
  mutate(mis_data2=mis_data-mis_copy, 
         mis_results2=mis_results-mis_data, 
         mis_easy2=mis_easy-mis_results,
         mis_hard2=mis_hard-mis_results) %>% 
  select(-contains('lueckl')) %>% 
  distinct(GH_ID, .keep_all = TRUE) %>% 
  ungroup()


# Häufigkeit von verscheidenen Anzahlen fehlender U-Untersuchungen
tbl1 <- tabyl(tmp$mis_copy[tmp$mis_copy>0]) %>% rename(anzahl = 1) %>% add_row(anzahl=7, n=0, percent=0)
tbl2 <- tabyl(tmp$mis_data2[tmp$mis_data2 > 0]) %>% rename(anzahl = 1)
tbl3 <- tabyl(tmp$mis_results2[tmp$mis_results2 > 0]) %>% rename(anzahl = 1)
tbl4 <- tabyl(tmp$mis_easy2[tmp$mis_easy2 > 0]) %>% rename(anzahl = 1)
tbl5 <- tabyl(tmp$mis_hard2[tmp$mis_hard2 > 0]) %>% rename(anzahl = 1)

# Gesamttabelle
tbl <- list(tbl1, tbl2, tbl3, tbl4, tbl5) %>% purrr::reduce(left_join, by = "anzahl")

tbl <- tbl %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate_at(vars(contains('percent')), ~ .*100)

# Output
tbl %>% 
  mutate_all(linebreak) %>%
  kbl2(col.names= c('Anzahl fehlend', rep(c('[n]', '[%]'),5))) %>% 
  add_header_above(c("", "Kopien" = 2, "Eintragungen" = 2, "Ergebnisseite" = 2, 
                     "LL* (vereinfacht)" = 2, "LL* (Vollständig)" = 2)) %>% 
  add_footnote("LL = Lückenlosigkeit", notation="symbol")
```


  \linebreak

Welche spezifischen U-Untersuchungen fehlen wie häufig?
```{r Lueckenlosigkeit_Heft_fehlendeUs, warning=FALSE, message=FALSE}
tmp <- lueckl_heft_u2u7a
tmp$u <- as.factor(tmp$u)

# Häufigkeit fehlender Us für verschiedene Kriterien ausgeben
tbl1 <- tabyl(tmp$u[tmp$kopien==0], show_missing_levels = TRUE)
tbl2 <- tabyl(tmp$u[tmp$kopien!=0 & tmp$data==0], show_missing_levels = TRUE)
tbl3 <- tabyl(tmp$u[(tmp$kopien!=0 & tmp$data!=0) & tmp$results==0], show_missing_levels = TRUE)
tbl4 <- tabyl(tmp$u[(tmp$kopien!=0 & tmp$data!=0 & tmp$results!=0) & tmp$ges_easy==0], show_na = FALSE)
tbl5 <- tabyl(tmp$u[(tmp$kopien!=0 & tmp$data!=0 & tmp$results!=0) & tmp$ges_hard==0], show_na = FALSE)

tbl <- bind_cols(tbl1, tbl2[2:length(tbl2)], tbl3[2:length(tbl3)], tbl4[2:length(tbl4)], tbl5[2:length(tbl5)])

# Tabelle in Form bringen
tbl <- tbl %>% 
  mutate_at(vars(contains('percent')), ~ .*100) %>%  
  adorn_totals('row', name='Gesamt')

tbl %>% kbl2(col.names= c('U-Untersuchung', rep(c('[n]', '[%]'),5))) %>% 
  add_header_above(c("", "Kopien" = 2, "Eintragungen" = 2, "Ergebnisseite" = 2, 
                     "LL* (vereinfacht)" = 2, "LL* (Vollständig)" = 2)) %>% 
  row_spec(7, extra_css = "border-bottom: 1px solid", hline_after=TRUE) %>% 
  add_footnote("LL = Lückenlosigkeit", notation="symbol")

```


## 4.7	Nutzung durch Eltern

### 4.7.4	Notizen der Eltern 

Häufigkeit von Einträgen der Eltern in den notizem im Abschnitt Elterninformationen
```{r Elterninfo}
# Variable umbenennen
names(dat) <- str_replace(names(dat), "Elterninfo_Freitext", "EInfo_Freitext")

tmp <- abs_freq(df=dat, x='Elterninfo') 

cat_names <- c('Ja', 'Nein')
tmp <- name_abs_tbl(df=tmp, namestring=cat_names, namecat = 'Eintrag liegt vor')

## absolute Tabelle
rowline_at <- nrow(tmp)-3
tmp %>% kbl2(col.names= c('Antwort', paste(names(.)[2:length(.)], '[n]', sep=' '))) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
# evtl. auch in den Wrapper packen

## relative Tabelle
tmp2 <- rel_freq(tmp)
names(tmp2) <- c('Antwort', paste(names(tmp2)[2:length(tmp2)], '[%]', sep=' '))

tmp2 %>% kbl2(align = align_string(tmp2)) %>% 
  row_spec(rowline_at, extra_css = "border-bottom: 1px solid", hline_after=TRUE)
```


  \linebreak

## LESEZEICHEN

Hier können Sie Ihre Notizen eintragen – Analyse der Freitexte
```{r Elterninfo_Freitext}

```


